<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asteroids 1979 - Atari Replica</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; color: #fff; font-family: 'Courier New', monospace; }
        #container { position: relative; width: 100vw; height: 100vh; background: radial-gradient(circle, #111 0%, #000 100%); }
        canvas { display: block; filter: drop-shadow(0 0 2px #fff); }

        /* UI Overlay */
        #ui { position: absolute; top: 15px; width: 100%; padding: 0 40px; box-sizing: border-box; display: flex; justify-content: space-between; z-index: 100; pointer-events: none; }
        .score-line { display: flex; gap: 40px; font-size: 24px; letter-spacing: 4px; }
        #lives-display { position: absolute; top: 65px; left: 40px; display: flex; gap: 8px; }
        .life-icon { width: 12px; height: 18px; border: 1.5px solid #fff; border-bottom: none; clip-path: polygon(50% 0%, 0% 100%, 100% 100%); }

        #leaderboard-btn, #close-btn { pointer-events: auto; background: none; border: 1px solid #fff; color: #fff; cursor: pointer; padding: 5px 12px; font-family: inherit; transition: 0.2s; }
        #leaderboard-btn:hover { background: #fff; color: #000; }

        /* Modals */
        .modal { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; width: 100%; pointer-events: none; display: none; z-index: 50; }
        #attract { display: block; }

        .flicker { font-size: 80px; letter-spacing: 12px; margin: 0; animation: flash 0.05s infinite; text-shadow: 0 0 10px rgba(255,255,255,0.5); }
        .blink-text { font-size: 20px; animation: blink 0.8s infinite step-end; letter-spacing: 3px; margin-top: 20px; }
        @keyframes flash { 0% { opacity: 0.9; } 50% { opacity: 1; } 100% { opacity: 0.95; } }
        @keyframes blink { 50% { opacity: 0; } }

        #leaderboard-modal { background: rgba(0,0,0,0.9); border: 2px solid #fff; padding: 30px; width: 300px; pointer-events: auto; }
        #score-list { list-style: none; padding: 0; font-size: 22px; margin: 20px 0; line-height: 1.8; }
        .small-text { font-size: 14px; color: #666; margin-top: 20px; }
        .credits { font-size: 12px; margin-top: 50px; color: #444; }
        
        /* Scanline CRT Effect Overlay */
        #crt-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03)); background-size: 100% 3px, 3px 100%; pointer-events: none; z-index: 1000; }
    </style>
</head>
<body>

<div id="container">
    <div id="crt-overlay"></div>
    <div id="ui">
        <div class="score-line">
            <div class="score-box">1 <br> <span id="score">00</span></div>
            <div class="score-box">HI-SCORE <br> <span id="hi-score">5000</span></div>
        </div>
        <div id="lives-display"></div>
        <button id="leaderboard-btn">LEADERBOARD</button>
    </div>
    
    <canvas id="gameCanvas"></canvas>
    
    <div id="attract" class="modal">
        <h1 class="flicker">ASTEROIDS</h1>
        <p class="blink-text">PRESS ANY KEY TO BEGIN</p>
        <div class="credits">Â© 1979 ATARI INC</div>
    </div>

    <div id="game-over" class="modal">
        <h2 class="flicker">GAME OVER</h2>
        <p>FINAL SCORE: <span id="final-score">0</span></p>
        <p class="small-text">PRESS ANY KEY TO RETURN</p>
    </div>

    <div id="leaderboard-modal" class="modal">
        <h3>RANKINGS</h3>
        <ul id="score-list"></ul>
        <button id="close-btn">CLOSE</button>
    </div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const attract = document.getElementById('attract');
    const gameOver = document.getElementById('game-over');
    const scoreEl = document.getElementById('score');
    const livesDisplay = document.getElementById('lives-display');

    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    let state = 'ATTRACT', score = 0, hiScore = localStorage.getItem('ast_hi') || 5000;
    let lives = 3, ship, asteroids = [], bullets = [], particles = [], saucer = null, saucerBullets = [];
    const keys = {};

    

    function spawnAsteroid(x, y, r = 55, lvl = 3) {
        asteroids.push({
            x: x || Math.random() * canvas.width,
            y: y || Math.random() * canvas.height,
            r, lvl,
            xv: (Math.random() - 0.5) * (4 - lvl) * 2.5,
            yv: (Math.random() - 0.5) * (4 - lvl) * 2.5,
            v: Math.floor(Math.random() * 5 + 7),
            off: Array.from({length: 12}, () => Math.random() * 0.4 + 0.8),
            a: Math.random() * Math.PI * 2,
            rot: Math.random() * 0.02 - 0.01
        });
    }

    function initGame() {
        state = 'PLAYING';
        attract.style.display = 'none';
        gameOver.style.display = 'none';
        score = 0; lives = 3;
        ship = resetShip();
        asteroids = []; bullets = []; saucer = null; saucerBullets = [];
        updateLivesUI();
        for(let i=0; i<4; i++) spawnAsteroid();
    }

    function resetShip() {
        return { x: canvas.width/2, y: canvas.height/2, r: 10, a: -Math.PI/2, xv: 0, yv: 0, blink: 90 };
    }

    function die() {
        for(let i=0; i<15; i++) particles.push({x: ship.x, y: ship.y, xv: (Math.random()-0.5)*8, yv: (Math.random()-0.5)*8, life: 40});
        lives--;
        updateLivesUI();
        if (lives <= 0) {
            state = 'GAME_OVER';
            document.getElementById('final-score').innerText = score;
            gameOver.style.display = 'block';
            saveScore(score);
            ship = null;
        } else {
            ship = resetShip();
        }
    }

    function updateLivesUI() {
        livesDisplay.innerHTML = '';
        for(let i=0; i<lives; i++) {
            const icon = document.createElement('div');
            icon.className = 'life-icon';
            livesDisplay.appendChild(icon);
        }
    }

    function wrap(o) {
        if (o.x < -25) o.x = canvas.width + 25; if (o.x > canvas.width + 25) o.x = -25;
        if (o.y < -25) o.y = canvas.height + 25; if (o.y > canvas.height + 25) o.y = -25;
    }

    function update() {
        asteroids.forEach(ast => { 
            ast.x += ast.xv; ast.y += ast.yv; wrap(ast); 
            if (state === 'PLAYING' && ship && ship.blink === 0 && Math.hypot(ship.x - ast.x, ship.y - ast.y) < ast.r + 8) die();
        });

        if (state === 'PLAYING' && ship) {
            if (keys.KeyW) { ship.xv += Math.cos(ship.a) * 0.15; ship.yv += Math.sin(ship.a) * 0.15; }
            if (keys.KeyA) ship.a -= 0.09;
            if (keys.KeyD) ship.a += 0.09;
            ship.xv *= 0.99; ship.yv *= 0.99;
            ship.x += ship.xv; ship.y += ship.yv;
            wrap(ship);
            if (ship.blink > 0) ship.blink--;
        }

        // Bullet collision
        bullets.forEach((b, i) => {
            b.x += b.xv; b.y += b.yv; wrap(b);
            asteroids.forEach((ast, ai) => {
                if (Math.hypot(b.x - ast.x, b.y - ast.y) < ast.r) {
                    if (ast.lvl > 1) { spawnAsteroid(ast.x, ast.y, ast.r/2, ast.lvl-1); spawnAsteroid(ast.x, ast.y, ast.r/2, ast.lvl-1); }
                    score += (ast.lvl === 3 ? 20 : 100); bullets.splice(i, 1); asteroids.splice(ai, 1);
                }
            });
            if (--b.life <= 0) bullets.splice(i, 1);
        });

        if (state === 'PLAYING' && asteroids.length === 0) for(let i=0; i<5; i++) spawnAsteroid();
    }

    function draw() {
        ctx.fillStyle = '#000'; ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.strokeStyle = '#fff'; ctx.lineWidth = 1.8;

        asteroids.forEach(ast => {
            ctx.beginPath();
            for(let j=0; j<ast.v; j++) {
                let ang = ast.a + j * (Math.PI*2/ast.v);
                ctx.lineTo(ast.x + ast.r * ast.off[j] * Math.cos(ang), ast.y + ast.r * ast.off[j] * Math.sin(ang));
            }
            ctx.closePath(); ctx.stroke();
        });

        if (state === 'PLAYING' && ship) {
            if (ship.blink === 0 || Math.floor(Date.now()/80)%2) {
                ctx.beginPath();
                ctx.moveTo(ship.x + 15*Math.cos(ship.a), ship.y + 15*Math.sin(ship.a));
                ctx.lineTo(ship.x + 10*Math.cos(ship.a+2.4), ship.y + 10*Math.sin(ship.a+2.4));
                ctx.lineTo(ship.x + 10*Math.cos(ship.a-2.4), ship.y + 10*Math.sin(ship.a-2.4));
                ctx.closePath(); ctx.stroke();
            }
            scoreEl.innerText = score;
        }

        ctx.fillStyle = "#fff";
        bullets.forEach(b => ctx.fillRect(b.x-1, b.y-1, 2, 2));
        particles.forEach((p, i) => { 
            ctx.fillRect(p.x, p.y, 1, 1); p.x += p.xv; p.y += p.yv; 
            if (--p.life <= 0) particles.splice(i, 1); 
        });

        update();
        requestAnimationFrame(draw);
    }

    function saveScore(s) {
        let scores = JSON.parse(localStorage.getItem('ast_scores') || "[]");
        scores.push(s); scores.sort((a,b) => b-a);
        localStorage.setItem('ast_scores', JSON.stringify(scores.slice(0, 5)));
        if (s > hiScore) { hiScore = s; localStorage.setItem('ast_hi', s); }
        document.getElementById('hi-score').innerText = hiScore;
    }

    window.addEventListener('keydown', e => {
        if (state === 'ATTRACT' && document.getElementById('leaderboard-modal').style.display !== 'block') initGame();
        else if (state === 'GAME_OVER') { state = 'ATTRACT'; gameOver.style.display = 'none'; attract.style.display = 'block'; asteroids = []; for(let i=0; i<6; i++) spawnAsteroid(); }
        else if (state === 'PLAYING') {
            keys[e.code] = true;
            if (e.code === 'Space' && bullets.length < 4) bullets.push({ x: ship.x, y: ship.y, xv: Math.cos(ship.a)*10, yv: Math.sin(ship.a)*10, life: 60 });
        }
    });
    window.addEventListener('keyup', e => keys[e.code] = false);

    document.getElementById('leaderboard-btn').onclick = (e) => {
        e.stopPropagation();
        const scores = JSON.parse(localStorage.getItem('ast_scores') || "[5000, 2000, 1000]");
        document.getElementById('score-list').innerHTML = scores.map((s, i) => `<li>${i+1}. ${s}</li>`).join('');
        document.getElementById('leaderboard-modal').style.display = 'block';
    };
    document.getElementById('close-btn').onclick = (e) => { e.stopPropagation(); document.getElementById('leaderboard-modal').style.display = 'none'; };

    // Start with background floaters
    document.getElementById('hi-score').innerText = hiScore;
    for(let i=0; i<6; i++) spawnAsteroid();
    draw();
</script>
</body>
</html>
